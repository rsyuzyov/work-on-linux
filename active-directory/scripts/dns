#!/bin/bash

DNS_CONFIG="./.dns"

create_dns_file() {
  echo "Файл конфигурации $DNS_CONFIG не найден."
  read -p "Введите SERVER (DNS сервер): " SERVER
  read -p "Введите ZONE (DNS зона, например example.com): " ZONE
  read -p "Введите LOGIN (пользователь): " LOGIN
  read -s -p "Введите PASSWORD: " PASSWORD
  echo
  cat > "$DNS_CONFIG" <<EOF
SERVER=$SERVER
ZONE=$ZONE
LOGIN=$LOGIN
PASSWORD=$PASSWORD
EOF
  echo "Файл конфигурации создан: $DNS_CONFIG"
}

if [[ ! -f "$DNS_CONFIG" ]]; then
  create_dns_file
fi

source "$DNS_CONFIG"

usage() {
  echo "Использование:"
  echo "$0 add|change|delete|show|clear <ИмяХоста> [IP-адрес]"
  echo "  add <ИмяХоста> <IP-адрес>    - добавить A-запись"
  echo "  change <ИмяХоста> <IP-адрес> - изменить A-запись (запросит старый IP)"
  echo "  delete <ИмяХоста> <IP-адрес> - удалить A-запись"
  echo "  show <ИмяХоста>              - показать IP для хоста"
  echo "  clear                        - удалить файл конфигурации .dns"
  exit 1
}

if [[ $# -lt 1 ]]; then
  usage
fi

ACTION=$1
NAME=$2
IP=$3

add_record() {
  samba-tool dns add "$SERVER" "$ZONE" "$NAME" A "$IP" -U "$LOGIN%$PASSWORD"
}

delete_record() {
  samba-tool dns delete "$SERVER" "$ZONE" "$NAME" A "$IP" -U "$LOGIN%$PASSWORD"
}

change_record() {
  read -p "Введите старый IP для изменения: " OLD_IP
  samba-tool dns update "$SERVER" "$ZONE" "$NAME" A "$OLD_IP" "$IP" -U "$LOGIN%$PASSWORD"
}

show_record() {
  samba-tool dns query "$SERVER" "$ZONE" "$NAME" A -U "$LOGIN%$PASSWORD"
}

clear_config() {
  if [[ -f "$DNS_CONFIG" ]]; then
    rm -f "$DNS_CONFIG"
    echo "Файл конфигурации $DNS_CONFIG удалён."
  else
    echo "Файл конфигурации не найден."
  fi
}

case "$ACTION" in
  add)
    [[ -z "$NAME" || -z "$IP" ]] && usage
    add_record
    ;;
  delete)
    [[ -z "$NAME" || -z "$IP" ]] && usage
    delete_record
    ;;
  change)
    [[ -z "$NAME" || -z "$IP" ]] && usage
    change_record
    ;;
  show)
    [[ -z "$NAME" ]] && usage
    show_record
    ;;
  clear)
    clear_config
    ;;
  *)
    echo "Неверное действие: $ACTION"
    usage
    ;;
esac
